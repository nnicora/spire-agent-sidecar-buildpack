#!/bin/bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4

echo "Supply script called with parameters $@"

export BUILDPACK_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`

echo "-----> Running SPIRE Agent sidecar supply"

echo '---
processes:
- type: "spire_agent"
  command: ".$HOME/.cloudfoundry/spire-agent run -config agent.conf"
  limits:
    memory: 100
  platforms:
    cloudfoundry:
      sidecar_for: [ "web"]
' > "$DEPS_DIR"/"$DEPS_IDX"/launch.yml


cp "$BUILDPACK_DIR/spire-agent" "$HOME/.cloudfoundry"

ls -l "$HOME/.cloudfoundry"

echo "-----> Wrote sidecar config to $DEPS_DIR/$DEPS_IDX/launch.yml"