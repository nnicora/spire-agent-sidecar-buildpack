#!/bin/bash

set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4

echo "-----> Running sidecar supply"

export BUILDPACK_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`
source "$BUILDPACK_DIR/scripts/install_go.sh"
output_dir=$(mktemp -d -t supplyXXX)

echo "-----> Running go build supply"
pushd $BUILDPACK_DIR
echo '---
processes:
- type: "sidecar_process"
  command: "./spire-agent run -config agent.conf"
  limits:
    memory: 100
  platforms:
    cloudfoundry:
      sidecar_for: [ "web"]
' > "$DEPS_DIR"/"$DEPS_IDX"/launch.yml
popd