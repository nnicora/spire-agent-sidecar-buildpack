#!/bin/bash

set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4

BUILDPACK_DIR=$(dirname "$(readlink -f "${BASH_SOURCE%/*}")")
export BUILDPACK_DIR

source "$BUILDPACK_DIR/scripts/install_go.sh"

echo "-----> Building SPIRE agent supply"
supply_temp_dir=$(mktemp -d -t supplyXXX)
pushd "$BUILDPACK_DIR"
# shellcheck disable=SC2154
"$GOROOT_TEMP/bin/go" build -mod=vendor -o "$supply_temp_dir/supply" ./src/spire/supply/cli
popd

echo "-----> Running SPIRE agent supply"
"$supply_temp_dir/supply" "$BUILD_DIR" "$CACHE_DIR" "$DEPS_DIR" "$DEPS_IDX"
