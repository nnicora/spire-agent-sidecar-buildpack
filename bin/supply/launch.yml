#!/bin/bash

set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4

LAUNCH_CONTENTS='---
processes:
  - type: spire-agent
    command: "./spire-agent run -config agent.conf"
    platforms:
      cloudfoundry:
        sidecar_for: [ "web"]
  - type: app-proxy-envoy
    command: "/etc/cf-assets/envoy/envoy -c /home/vcap/app/custom-envoy.yaml --base-id 45 --log-level debug --component-log-level router:trace,upstream:debug,connection:trace,grpc:trace,forward_proxy:debug,ext_authz:debug"
    platforms:
      cloudfoundry:
        sidecar_for: [ "web" ]
'
  
echo "-----> Running sidecar supply"

export BUILDPACK_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`

pushd "$BUILDPACK_DIR"
echo "$LAUNCH_CONTENTS" > "$DEPS_DIR"/"$DEPS_IDX"/launch.yml
popd